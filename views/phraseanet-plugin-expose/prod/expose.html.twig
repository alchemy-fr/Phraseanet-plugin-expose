<div>
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" id="exposeTabs">
        <li role="presentation" class="active"><a href="#pubCreate" aria-controls="about" role="tab" data-toggle="tab">Publication create</a></li>
        <li class="{{ divId }}" role="presentation"><a href="#pubList" aria-controls="pub-list" role="tab" data-toggle="tab" data-url="/expose/list-publication">Publication list</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">

        <div role="tabpanel" class="tab-pane fade in active" id="pubCreate">
            <div id='expose-plugin'>
                <div style="overflow: scroll;">
                    <button type="button" class="btn btn-success" id="create-publication">
                        Create publication {% if lst %} from {{ lst|split(';')|length }} selected {% endif %}
                    </button>
                    <br/>
                    <textarea class="publication-data" name="publication-data" rows="10" cols="50">
{
    "title": "the title",
    "enabled": true,
    "layout": "gallery",
    "publiclyListed": true,
    "slug": "",
    "securityMethod": "",
    "securityOptions": {}
}
                    </textarea>
                    <span id="pub-error" class="hidden alert alert-error"></span>
                    <span id="pub-success" class="hidden alert alert-success"></span>
                </div>
            </div>
        </div>

        <div role="tabpanel" class="tab-pane fade" id="pubList">
        </div>
    </div>
</div>


<script type="text/javascript">
    // tab javascript
    var contentsDownloaded = {};
    var remoteContent = function(url) {
        return $.get(url);
    };

    var tabs = $('#exposeTabs a[data-toggle="tab"]');

    tabs.on('click', function(){
        $(this).tab('show');
    });

    $('.nav-tabs a').on('show.bs.tab', function (e) {
        if (e.target.hash != '#pubCreate' && contentsDownloaded[e.target.hash] === undefined) {
            $(e.target.hash).empty().html('<img src="/assets/common/images/icons/main-loader.gif" alt="loading"/>');
        }
    });

    $('.nav-tabs').on('shown.bs.tab', function (e) {

        if (e.target.hash != '#pubCreate' && contentsDownloaded[e.target.hash] === undefined) {
            var targetDiv = $(e.target.hash);

            remoteContent($(e.target).attr('data-url')).then(function(response) {
                targetDiv.empty().html(response);
                contentsDownloaded[e.target.hash] = true;
            }, function(error) {
                console.log(error);
                targetDiv.empty().html('<i class="icon-fire">Unable to load content!</i>');
            });
        }
    });

    // end display tab

    $(document).on('click', '#create-publication', function (e) {
        e.preventDefault();
        var publicationData = $('.publication-data');

        try {
            $("#pub-error").addClass("hidden");
            JSON.parse(publicationData.val());
        } catch (err) {
            $("#pub-error").removeClass("hidden").text(err.message);

            return;
        }

        $.ajax({
            type: "POST",
            url: "../expose/create-publication/",
            dataType: 'json',
            data: {
                lst: {{ lst|json_encode|raw }},
                publicationData:  publicationData.val()
            },
            success: function (data) {
                if (data.success) {
                    $("#pub-success").removeClass("hidden").text(data.message + " " + data.url);
                } else {
                    $("#pub-error").removeClass("hidden").text(data.message);
                }
            }
        });
    });

    $(document).on('keyup', '.publication-data', function (e) {
        try {
            $("#pub-success").addClass("hidden");
            $("#pub-error").addClass("hidden");
            JSON.parse($(this).val());
        } catch (err) {
            $("#pub-error").removeClass("hidden").text(err.message);
        }
    });

</script>
